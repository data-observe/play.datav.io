import{R,V as L,W as z,X as H,Y as b,Z as k,_ as A,a0 as F,a1 as J,Q as M,a2 as W}from"./index-9076ce45.js";import{r as h,au as E,V as S,aP as j,ar as q,av as V,aq as $,di as Q,_ as X,d1 as B,dz as Y,cO as G,ay as D,h5 as K,h6 as U,eS as I,bm as ee}from"./index-3a76b207.js";import"./useLandscapeMode-e7a72966.js";function i(e,t){this._bmap=e,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=t,this._projection=new BMap.MercatorProjection}i.prototype.type="bmap";i.prototype.dimensions=["lng","lat"];i.prototype.setZoom=function(e){this._zoom=e};i.prototype.setCenter=function(e){this._center=this._projection.lngLatToPoint(new BMap.Point(e[0],e[1]))};i.prototype.setMapOffset=function(e){this._mapOffset=e};i.prototype.getBMap=function(){return this._bmap};i.prototype.dataToPoint=function(e){var t=new BMap.Point(e[0],e[1]),n=this._bmap.pointToOverlayPixel(t),a=this._mapOffset;return[n.x-a[0],n.y-a[1]]};i.prototype.pointToData=function(e){var t=this._mapOffset;return e=this._bmap.overlayPixelToPoint({x:e[0]+t[0],y:e[1]+t[1]}),[e.lng,e.lat]};i.prototype.getViewRect=function(){var e=this._api;return new R(0,0,e.getWidth(),e.getHeight())};i.prototype.getRoamTransform=function(){return L()};i.prototype.prepareCustoms=function(){var e=this.getViewRect();return{coordSys:{type:"bmap",x:e.x,y:e.y,width:e.width,height:e.height},api:{coord:z(this.dataToPoint,this),size:z(te,this)}}};i.prototype.convertToPixel=function(e,t,n){return this.dataToPoint(n)};i.prototype.convertFromPixel=function(e,t,n){return this.pointToData(n)};function te(e,t){return t=t||[0,0],H([0,1],function(n){var a=t[n],o=e[n]/2,p=[],f=[];return p[n]=a-o,f[n]=a+o,p[1-n]=f[1-n]=t[1-n],Math.abs(this.dataToPoint(p)[n]-this.dataToPoint(f)[n])},this)}var w;i.dimensions=i.prototype.dimensions;function ne(){function e(t){this._root=t}return e.prototype=new BMap.Overlay,e.prototype.initialize=function(t){return t.getPanes().labelPane.appendChild(this._root),this._root},e.prototype.draw=function(){},e}i.create=function(e,t){var n,a=t.getDom();return e.eachComponent("bmap",function(o){var p=t.getZr().painter,f=p.getViewportRoot();if(typeof BMap>"u")throw new Error("BMap api is not loaded");if(w=w||ne(),n)throw new Error("Only one bmap component can exist");var s;if(!o.__bmap){var l=a.querySelector(".ec-extension-bmap");l&&(f.style.left="0px",f.style.top="0px",a.removeChild(l)),l=document.createElement("div"),l.className="ec-extension-bmap",l.style.cssText="position:absolute;width:100%;height:100%",a.appendChild(l);var r=o.get("mapOptions");r&&(r=b(r),delete r.mapType),s=o.__bmap=new BMap.Map(l,r);var d=new w(f);s.addOverlay(d),p.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}}}s=o.__bmap;var c=o.get("center"),u=o.get("zoom");if(c&&u){var m=s.getCenter(),v=s.getZoom(),y=o.centerOrZoomChanged([m.lng,m.lat],v);if(y){var _=new BMap.Point(c[0],c[1]);s.centerAndZoom(_,u)}}n=new i(s,t),n.setMapOffset(o.__mapOffset||[0,0]),n.setZoom(u),n.setCenter(c),o.coordinateSystem=n}),e.eachSeries(function(o){o.get("coordinateSystem")==="bmap"&&(o.coordinateSystem=n)}),n&&[n]};function oe(e,t){return e&&t&&e[0]===t[0]&&e[1]===t[1]}k({type:"bmap",getBMap:function(){return this.__bmap},setCenterAndZoom:function(e,t){this.option.center=e,this.option.zoom=t},centerOrZoomChanged:function(e,t){var n=this.option;return!(oe(e,n.center)&&t===n.zoom)},defaultOption:{center:[104.114129,37.550339],zoom:5,mapStyle:{},mapStyleV2:{},mapOptions:{},roam:!1}});function N(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}A({type:"bmap",render:function(e,t,n){var a=!0,o=e.getBMap(),p=n.getZr().painter.getViewportRoot(),f=e.coordinateSystem,s=function(_,g){if(!a){var P=p.parentNode.parentNode.parentNode,C=[-parseInt(P.style.left,10)||0,-parseInt(P.style.top,10)||0],O=p.style,Z=C[0]+"px",x=C[1]+"px";O.left!==Z&&(O.left=Z),O.top!==x&&(O.top=x),f.setMapOffset(C),e.__mapOffset=C,n.dispatchAction({type:"bmapRoam",animation:{duration:0}})}};function l(){a||n.dispatchAction({type:"bmapRoam",animation:{duration:0}})}o.removeEventListener("moving",this._oldMoveHandler),o.removeEventListener("moveend",this._oldMoveHandler),o.removeEventListener("zoomend",this._oldZoomEndHandler),o.addEventListener("moving",s),o.addEventListener("moveend",s),o.addEventListener("zoomend",l),this._oldMoveHandler=s,this._oldZoomEndHandler=l;var r=e.get("roam");r&&r!=="scale"?o.enableDragging():o.disableDragging(),r&&r!=="move"?(o.enableScrollWheelZoom(),o.enableDoubleClickZoom(),o.enablePinchToZoom()):(o.disableScrollWheelZoom(),o.disableDoubleClickZoom(),o.disablePinchToZoom());var d=e.__mapStyle,c=e.get("mapStyle")||{},u=JSON.stringify(c);JSON.stringify(d)!==u&&(N(c)||o.setMapStyle(b(c)),e.__mapStyle=JSON.parse(u));var m=e.__mapStyle2,v=e.get("mapStyleV2")||{},y=JSON.stringify(v);JSON.stringify(m)!==y&&(N(v)||o.setMapStyleV2(b(v)),e.__mapStyle2=JSON.parse(y)),a=!1}});F("bmap",i);J({type:"bmapRoam",event:"bmapRoam",update:"updateLayout"},function(e,t){t.eachComponent("bmap",function(n){var a=n.getBMap(),o=a.getCenter();n.setCenterAndZoom([o.lng,o.lat],a.getZoom())})});const pe=h.memo(e=>{const{panel:t,width:n,height:a}=e;if(!t.plugins.echarts.allowEmptyData&&E.isEmpty(e.data))return S.createElement(j,{height:"100%"},"No data");const{colorMode:o}=q(),p=V(),[f,s]=h.useState(null),l=$("edit"),[r,d]=h.useMemo(()=>{const u=e.data.flat();let m=null,v=null;const y=Q[e.panel.styles.palette]??X,_=B(t.plugins.echarts.setOptionsFunc);if(E.isFunction(_))try{m=_(E.cloneDeep(u),t.plugins.echarts.enableThresholds&&t.plugins.echarts.thresholds,y,M,Y,G,o)}catch(g){console.log("parse echarts options error",g)}else p({title:"set options error",description:"The setOptions function you defined is not valid",status:"error",duration:3e3,isClosable:!0});if(f){const g=B(t.plugins.echarts.registerEventsFunc);E.isFunction(g)?v=g:p({title:"register events error",description:"The registerEvents function you defined is not valid",status:"error",duration:3e3,isClosable:!0})}return m&&(m.animation=t.plugins.echarts.animation),[m,v]},[t.plugins.echarts,e.data,f]),c=(l==t.id.toString(),"transparent");return S.createElement(S.Fragment,null,r&&S.createElement(D,{height:a,key:o,className:"echarts-panel"},S.createElement(re,{options:r,theme:o,width:n-11,height:a,onChartCreated:u=>s(u),onChartEvents:t.plugins.echarts.enableClick?d:null,darkBg:c})))}),re=({options:e,theme:t,width:n,height:a,onChartCreated:o,onChartEvents:p,darkBg:f})=>{const s=h.useRef(null),l=V(),[r,d]=h.useState(null);return t=="dark"&&f&&(e.backgroundColor=f),h.useEffect(()=>{if(s.current){const c=W(s.current,t);d(c),T(()=>c.setOption(e),l),o(c)}return()=>{r&&(r==null||r.dispose(),r==null||r.clear())}},[]),h.useEffect(()=>{r&&T(()=>r.setOption(e),l)},[e]),h.useEffect(()=>{p&&r&&p(e,r,K,(c,u)=>U(c,u),I,ee)},[p]),h.useEffect(()=>{r&&T(()=>r.resize({width:n,height:a}),l)},[n,a]),S.createElement(D,{ref:s,width:n,height:a,className:"echart-container"})},T=(e,t)=>{const n="echarts-error";try{e()}catch(a){t.isActive(n)||t({id:n,title:`running echarts panel error: ${a.message}`,status:"warning",duration:3e3,isClosable:!0})}};export{re as EchartsComponent,pe as default};
