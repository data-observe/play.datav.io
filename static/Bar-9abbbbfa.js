import{r as b,ar as le,aZ as me,bk as q,cd as de,au as W,a1 as ue,a2 as he,aT as fe,a7 as j,d0 as pe,bU as G,d1 as ge,V as a,d2 as xe,cO as Z,d5 as ye,eR as oe,ad as _,d9 as we,ay as Q,cV as be,cW as ve,cX as Ee,cY as X,cZ as J,ax as Se,da as ke,aN as ee,aQ as M,cz as Te,cA as Ne,c_ as Ae,c$ as te,aP as ae,df as Ce,ab as De,di as Oe,_ as Le,g_ as se}from"./index-3a76b207.js";import{z as Fe,h as V,E as f,k as P,c as Y,d as E,r as Ie,T as K,a as ne,C as ze,F as Me}from"./index-9076ce45.js";import{G as We}from"./GraphLayout-463a0496.js";import"./useLandscapeMode-e7a72966.js";const Be=b.memo(n=>{const{panel:c,width:S,height:p}=n,e=c.plugins.bar,[l,B]=b.useState(null),{colorMode:k}=le();me(),b.useEffect(()=>(l&&l.on("click",function(s){s.seriesName!="total"}),()=>{l==null||l.off("click")}),[l]);let[w,L,v,u]=b.useMemo(()=>{const s=[],o=[],i=[];if(q(n.data))return[[],s,i,o];const x=de();let g=W.round(x.start.getTime()/1e3);const y=W.round(n.data[0].timestamps[0]);y<g&&(g=y);const C=new Date;let N=[];n.data.forEach((O,ie)=>{ie==0&&(N=O.timestamps.map(ce=>ce*1e3)),s.push(O.name),o.push(O.rawName),i.push(O.values)});const D=c.datasource,A=Fe(x,D.queryOptions.maxDataPoints??he,q(D.queryOptions.minInterval)?ue:D.queryOptions.minInterval),I=Pe(g*1e3,C.getTime(),A.intervalMs/1e3);return[N.map(O=>fe(O,{format:I})),s,i,o]},[n.data]);const t=Math.max(...v.flat());let d=b.useMemo(()=>(v.forEach((s,o)=>{const i=u[o];V(c,i,f.SeriesNegativeY)&&(v[o]=s.map(g=>-g))}),v),[v]),m;e.stack=="always"?m="total":e.stack=="none"?m=null:m=L.length>=4?"total":null;const r=10,[h,z]=Ye(S,w[0],r,w.length);let T;if(e.showLabel=="always"?T=!0:e.showLabel=="none"?T=!1:T=S/w.length>60,e.axis.scale==="log")for(const s of d)s.forEach((o,i)=>{o===0&&(s[i]="")});const F=c.overrides.find(s=>s.overrides.find(o=>o.type==f.SeriesNegativeY)),$=c.overrides.filter(s=>s.overrides.find(o=>o.type==f.SeriesYAxist)),U=[{id:0,type:e.axis.scale=="log"?"log":"value",logBase:e.axis.scaleBase,scalse:!0,splitLine:{show:e.showGrid},show:!0,splitNumber:e.axis.scale=="log"?null:3,axisLabel:{fontSize:e.styles.axisFontSize,formatter:s=>{let o=!0;if((s>=0||!F)&&(o=!1),F&&$.find(i=>i.target===F.target)&&(o=!1),o){const i=Y(c,F.target),x=E(i,f.SeriesUnit),g=E(i,f.SeriesDecimal);return P(s,x==null?void 0:x.units,g)}else return P(s,e.value.units,e.value.decimal)}}}],R={};for(const s of $){const o=s.target;if(!u.includes(o))continue;const i=U.length;U.push({id:i,position:"right",offset:(i-1)*40,type:e.axis.scale=="log"?"log":"value",logBase:e.axis.scaleBase,scalse:!0,splitLine:{show:!1},show:!0,splitNumber:e.axis.scale=="log"?null:3,axisLabel:{fontSize:e.styles.axisFontSize,formatter:x=>{const g=Y(c,o),y=E(g,f.SeriesUnit),C=E(g,f.SeriesDecimal);return P(x,(y==null?void 0:y.units)??e.value.units,C??e.value.decimal)}}}),R[o]=i}const H={animation:e.animation,animationDuration:500,tooltip:{show:!0,trigger:e.tooltip=="none"?"none":e.tooltip=="all"?"axis":"item",appendToBody:!0,axisPointer:{type:"shadow"},backgroundColor:j("rgba(255,255,255,0.7)","rgba(255,255,255,0.9)"),textStyle:{color:j("#444","#222")}},grid:{left:"1%",right:"1%",top:"4%",bottom:"1%",padding:0,containLabel:!0},[e.axis.swap?"yAxis":"xAxis"]:{type:"category",data:w,show:!0,axisTick:{alignWithLabel:!1},axisLabel:{show:!0,textStyle:{},interval:h,fontSize:e.styles.axisFontSize,rotate:e.axis.swap?0:z}},[e.axis.swap?"xAxis":"yAxis"]:U,series:L.map((s,o)=>{var A;const i=Y(c,u[o]),x=E(i,f.SeriesFill),g=E(i,f.SeriesUnit),y=E(i,f.SeriesDecimal),C=Ie((A=n.data.find(I=>I.name==s))==null?void 0:A.color,(x??e.styles.barOpacity)/100);let N=e.value.units,D=e.value.decimal;return g&&(N=g.units),y&&(D=y),{name:s,[e.axis.swap?"xAxisIndex":"yAxisIndex"]:R[u[o]]??0,data:d[o],type:"bar",stack:m,label:{show:T,formatter:I=>{const O=P(I.data,N,D);return e.showLabel=="always"||Math.abs(I.data)/t>=.2?O:""},fontSize:e.styles.labelFontSize,color:pe(C,k=="dark")},emphasis:{},color:C,barWidth:m=="total"?`${e.styles.barWidth}%`:`${e.styles.barWidth/L.length}%`,tooltip:{valueFormatter:I=>P(I,N,D)}}})};if(e.thresholdsDisplay!=K.None)for(const s of e.thresholds.thresholds)s.value!=null&&H.series.push({type:"line",symbol:"none",tooltip:{show:!1},markLine:{[e.axis.swap?"xAxisIndex":"yAxisIndex"]:0,silent:!0,symbol:[e.thresholdArrow,null],label:{show:!1},data:[{[e.axis.swap?"xAxis":"yAxis"]:e.thresholds.mode==ne.Absolute?s.value:s.value*t/100,lineStyle:{type:e.thresholdsDisplay==K.Line?"solid":"dashed",color:G(s.color,k),width:1}}]}});for(const s of c.overrides){const o=s.overrides.find(i=>i.type==f.SeriesThresholds);if(o&&o.value){const i=s.target,x=o.value.mode;let g=u.indexOf(i);const y=d[g];if(!y)continue;const C=V(c,i,f.SeriesNegativeY);let N;C?N=Math.min(...y):N=Math.max(...y);const D=V(c,i,f.SeriesYAxist);for(const A of o.value.thresholds)A.value!=null&&H.series.push({[e.axis.swap?"xAxisIndex":"yAxisIndex"]:R[i]??0,type:"line",symbol:"none",tooltip:{show:!1},markLine:{silent:!0,symbol:D===null?[null,e.thresholdArrow]:[e.thresholdArrow,null],label:{show:!1},data:[{[e.axis.swap?"xAxis":"yAxis"]:x==ne.Absolute?C?-A.value:A.value:A.value*N/100,lineStyle:{type:e.thresholdsDisplay==K.Line?"solid":"dashed",color:G(A.color,k),width:1}}]}})}}const re=ge(c.plugins.bar.onClickEvent);return a.createElement(a.Fragment,null,a.createElement(ze,{key:k,options:H,theme:k,onChartCreated:s=>B(s),width:S,onChartEvents:c.plugins.bar.enableClick?s=>xe(re,s):null,clearWhenSetOption:!0}))}),Pe=(n,c,S)=>{const p=Z(n),e=Z(c);let l;return p.isSame(e,"month")?l="":l="M-",p.isSame(e,"day")?l+="HH:mm":l+="DD HH:mm",S<60&&(l+=":ss"),l},Ye=(n,c,S,p)=>{const e=ye(c,S).width+10;return W.floor(n/e),[null,0]},Ue=b.memo(({props:n,data:c,width:S,onSeriesActive:p,inactiveSeries:e})=>{const l=n.panel.plugins.bar,B=oe+n.dashboardId+"-"+n.panel.id;b.useEffect(()=>{e.length>0?_.set(B,e):_.remove(B)},[e]);const k=Me(t=>t.key==="Shift"?(t.stopPropagation(),t.preventDefault(),!0):!1),w=l.value,L=[];for(const t of c){let d=[];for(const m of l.legend.valueCalcs)d.push([m,we(t.fields[1].values,m)]);L.push({name:t.name,value:d,color:t.color,rawName:t.rawName})}const v=W.orderBy(L,t=>{for(const d of t.value)if(d[0]==l.legend.order.by)return d[1]==null?0:d[1]},l.legend.order.sort);for(const t of v){const d=Y(n.panel,t.rawName),m=E(d,f.SeriesUnit);let r=w.units,h=w.unitsType,z=w.decimal;m&&(r=m.units,h=m.unitsType);const T=E(d,f.SeriesDecimal);T&&(z=T),t.units=r,t.unitsType=h,t.decimal=z}const u=(t,d,m)=>{if(m){if(e.length==0){const r=[];for(const h of c)h.name!=t&&r.push(h.name);p(r);return}if(e.includes(t)){const r=e.filter(h=>h!=t);p(r)}else{const r=[...e];r.push(t),p(r)}}else if(e.length==0){const r=[];for(const h of c)h.name!=t&&r.push(h.name);p(r)}else if(e.includes(t)){const r=[];for(const h of c)h.name!=t&&r.push(h.name);p(r)}else p([])};return a.createElement(Q,{fontSize:"xs",width:"100%"},a.createElement(be,{maxW:l.legend.placement=="bottom"?n.width:S,p:0,marginLeft:"-18px",sx:{"::-webkit-scrollbar":{width:"1px",height:"1px"}}},a.createElement(ve,{variant:"unstyled",size:"sm",p:"0"},a.createElement(Ee,null,a.createElement(X,null,a.createElement(J,null," "),v[0].value.map(t=>a.createElement(J,{width:"50px",fontSize:"0.8remt",pt:"0",pb:"1",pr:"1",pl:"0",textAlign:"center",fontWeight:"500",onClick:()=>{l.legend.order={by:t[0],sort:l.legend.order.sort=="asc"?"desc":"asc"},Se({type:ke,data:W.cloneDeep(n.panel)})}},a.createElement(ee,{spacing:0,justifyContent:"end",cursor:"pointer",position:"relative"},a.createElement(M,null,t[0]),a.createElement(M,null," ",l.legend.order.by==t[0]&&a.createElement(M,{fontSize:"0.6rem",opacity:"0.7",position:"absolute",top:"3.5px"},l.legend.order.sort=="asc"?a.createElement(Te,null):a.createElement(Ne,null)))))))),a.createElement(Ae,null,v.map((t,d)=>a.createElement(X,{verticalAlign:"top",width:"100%"},a.createElement(te,{fontSize:"0.75rem",py:"1",cursor:"pointer",onClick:()=>u(t.name,d,k[0])},a.createElement(ee,{alignItems:"start",opacity:e.includes(t.name)?"0.6":1,userSelect:"none"},a.createElement(Q,{width:"10px",minWidth:"10px",height:"4px",background:t.color,mt:"7.5px"}),l.legend.placement=="bottom"?a.createElement(M,{noOfLines:3,minWidth:"fit-content",wordBreak:"break-all",whiteSpace:"break-spaces"},t.name):a.createElement(M,{w:l.legend.nameWidth==="full"?"100%":l.legend.nameWidth+"px",noOfLines:3,wordBreak:"break-all",whiteSpace:l.legend.nameWidth==="full"?"nowrap":"break-spaces"},t.name))),t.value.map((m,r)=>a.createElement(te,{textAlign:"right",fontSize:"0.75rem",py:"1",px:"1"},m[1]?t.unitsType!="none"?P(m[1],t.units,t.decimal):W.round(m[1],t.decimal):m[1]))))))))}),Ge=b.memo(n=>q(n.data)?a.createElement(ae,{height:"100%"},"No data"):a.createElement(a.Fragment,null,Ce(n.data)?a.createElement(Re,{...n}):a.createElement(ae,{height:"100%"},a.createElement(De,null,a.createElement(M,{fontWeight:500,fontSize:"1.1rem"},"Data format not support!"),a.createElement(M,{className:"color-text"},"Try to change to Testdata or Prometheus datasource, then look into its data format in Panel Debug"))))),Re=n=>{const{panel:c,width:S}=n,p=n.panel.plugins.bar,e=oe+n.dashboardId+"-"+n.panel.id,[l,B]=b.useState(_.get(e)??[]),{colorMode:k}=le(),w=b.useMemo(()=>{const u=[],t=Oe[n.panel.styles.palette]??Le;return n.data.forEach(d=>{W.cloneDeep(d).forEach((r,h)=>{r.rawName=r.name;const z=Y(n.panel,r.rawName),T=E(z,f.SeriesName);T?r.name=T:r.name=r.rawName;let F=E(z,f.SeriesColor);F||(F=t[h%t.length]),r.color=G(F,k),u.push(r)})}),u},[n.data,k,c.overrides,c.styles.palette]),L=b.useCallback(u=>{B(u)},[]),v=b.useMemo(()=>{const u=[];for(const t of w){if(l.includes(t.name))continue;const d={rawName:t.rawName,name:t.name,color:t.color};for(const m of t.fields){if(d.timestamps&&d.values)break;m.type==se.Time?d.timestamps=m.values:m.type==se.Number&&(d.values=m.values)}u.push(d)}return u},[w,l]);return a.createElement(a.Fragment,null,a.createElement(We,{width:n.width,height:n.height,legend:p.legend.show?a.createElement(Ue,{placement:p.legend.placement,width:p.legend.width,props:n,data:w,inactiveSeries:l,onSeriesActive:L}):null},(u,t)=>a.createElement(Be,{data:v,width:u,height:t,panel:c})))};export{Ge as default};
