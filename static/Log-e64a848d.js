import{r as s,ar as _,V as e,ay as b,aS as F,aN as O,cP as q,aQ as m,ba as R,bl as re,cv as ce,c5 as ie,ac as me,ab as G,bU as B,au as T,aT as P,gZ as ue,cQ as he,bk as ge,aP as Z,ad as D,di as pe,cM as fe,dj as be,aR as de,cl as Ee}from"./index-3a76b207.js";import{v as $,L as K,w as I,x as Ce,y as ye}from"./index-9076ce45.js";import{C as Se}from"./useLandscapeMode-e7a72966.js";const ve=s.memo(o=>{const{active:u,labels:n,panel:w,onCollapseAll:k,onSearchChange:d,height:h,onActiveLabel:L,activeOp:M,onActiveOpChange:l,currentLogsCount:H,viewOptions:i,onViewLogChange:E,colorGenerator:x}=o,[A,S]=s.useState(""),{colorMode:z}=_(),g=w.plugins.log,t=r=>g.styles.labelColorSyncChart?$(r,z,x):B(g.styles.labelValueColor);return e.createElement(b,null,e.createElement(F,{justifyContent:"space-between",py:"2",pl:"1",pr:"5",fontSize:"0.85rem",mt:"-3px"},e.createElement(O,{spacing:1},e.createElement(q,{cursor:"pointer",style:{transform:"rotate(90deg)"},onClick:()=>k(!1)}),e.createElement(q,{cursor:"pointer",onClick:()=>k(!0)})),e.createElement(O,{spacing:1},e.createElement(m,{className:"color-text"},H),e.createElement(m,{opacity:"0.7"},"logs")),e.createElement(b,null)),e.createElement(R,{mt:""}),e.createElement(b,{fontSize:"0.8rem",mt:"2",px:"1"},e.createElement(m,{mb:"1",fontWeight:"500"},"Search log content"),e.createElement(re,{value:A,onChange:r=>{S(r),d(r)},placeholder:"textA || textB , A && B"})),e.createElement(R,{mt:"2"}),e.createElement(b,{fontSize:"0.8rem",mt:"3",px:"1"},e.createElement(m,{mb:"1",fontWeight:"500"},"Chart options"),e.createElement(m,{mb:"1",fontSize:"0.7rem",ml:"2px"},"Max bars count"),e.createElement(ce,{value:i.maxBars,min:15,max:100,step:1,onChange:r=>{E({...i,maxBars:r})}}),e.createElement(m,{mb:"1",fontSize:"0.7rem",ml:"2px"},"Bar type"),e.createElement(ie,{size:"xs",options:[{label:"Total",value:"total"},{label:"Labels",value:"labels"}],value:i.barType,onChange:r=>E({...i,barType:r})})),e.createElement(R,{mt:"3"}),e.createElement(b,{px:"1",mt:"2"},e.createElement(F,{alignItems:"center",justifyContent:"space-between"},e.createElement(m,{mb:"1",fontSize:"0.8rem",fontWeight:"500"},"Label filter"),e.createElement(me,{size:"xs",mt:"-1",onClick:l},M.toUpperCase())),e.createElement(G,{mt:"2",alignItems:"left",maxHeight:"400px",overflowY:"auto"},n.map(r=>e.createElement(b,{fontSize:"0.85rem",className:u.includes(r.id)?"highlight-bordered":"bordered",onClick:()=>L(r.id),cursor:"pointer",px:"2",py:"1"},e.createElement(m,{color:t(r.id)},r.name),e.createElement(O,null,e.createElement(m,{color:B(g.styles.labelValueColor)},r.value),e.createElement(m,null," (",r.count,")")))))))}),we=s.memo(o=>{const{log:u,panel:n,width:w,colorGenerator:k}=o,{colorMode:d}=_(),h=u.labels,[L,M]=s.useState(!0);s.useEffect(()=>{M(o.collapsed)},[o.collapsed]);const l=n.plugins.log,H=l.labels.layout==K.Horizontal?O:b,i=s.useMemo(()=>{for(const t of n.plugins.log.thresholds)if(!(t.type!==null&&T.isEmpty(t.value))){if(t.type=="label"){for(const r of Object.keys(h))if(r==t.key&&h[r].match(t.value))return t.color}if(t.type=="content"&&u.content.toLowerCase().match(t.value)||t.type==null)return t.color}},[n.plugins.log.thresholds,u,h]);let E;const x=u.timestamp.toString().slice(13),A=x.slice(0,3),S=u.timestamp/1e6;switch(l.timeStampPrecision){case"ns":E=P(S,{format:"YY-MM-DD HH:mm:ss.SSS"})+x;break;case"us":E=P(S,{format:"YY-MM-DD HH:mm:ss.SSS"})+A;break;case"ms":E=P(S,{format:"YY-MM-DD HH:mm:ss.SSS"});break;default:E=P(S,{format:"YY-MM-DD HH:mm:ss"});break}const z=t=>l.styles.labelColorSyncChart?$(t,d,k):l.styles.labelColor,g=w<he;return e.createElement(e.Fragment,null,e.createElement(F,{flexDir:g?"column":"row",pt:"1",alignItems:"start",gap:g?1:2,pl:"2",pr:"4",onClick:()=>M(!L),cursor:"pointer",fontSize:l.styles.fontSize},e.createElement(O,{spacing:1},e.createElement(Se,{collapsed:L,fontSize:"0.6rem",opacity:"0.6",mt:l.showTime?0:"6px"}),l.showTime&&e.createElement(m,{minWidth:l.timeColumnWidth??155,color:B(i)},E)),l.labels.display.length>0&&e.createElement(O,{minWidth:l.labels.width??l.labels.display.length*150,maxWidth:g?null:l.labels.width??300,spacing:l.labels.layout==K.Horizontal?2:3},Object.keys(h).map(t=>l.labels.display.includes(t)&&e.createElement(H,{key:t+h[t],spacing:0},e.createElement(J,{name:t,color:z(I(t,h[t]))}),l.labels.layout==K.Horizontal&&e.createElement(m,null,"="),e.createElement(X,{value:h[t],color:l.styles.labelValueColor})))),e.createElement(m,{wordBreak:l.styles.wordBreak,color:B(l.styles.contentColor)},e.createElement(ue,{query:u.highlight??[],styles:{px:"1",py:"1",borderRadius:4,bg:"teal.100"}},u.content))),!L&&e.createElement(b,{p:"4",fontSize:l.styles.fontSize},e.createElement(G,{alignItems:"left",className:"bordered",p:"2"},Object.keys(h).map(t=>e.createElement(O,{key:t+h[t],px:"2",spacing:1},e.createElement(b,{minWidth:g?"10em":"20em"},e.createElement(J,{name:t,color:z(I(t,h[t]))})),e.createElement(X,{value:h[t],color:l.styles.labelValueColor}))))))}),J=({name:o,color:u})=>e.createElement(m,{fontWeight:500,color:B(u)},o),X=({value:o,color:u})=>e.createElement(m,{color:B(u)},o),De=s.memo(o=>ge(o.data)?e.createElement(Z,{height:"100%"},"No data"):e.createElement(e.Fragment,null,Ce(o.data[0][0])?e.createElement(Le,{...o}):e.createElement(Z,{height:"100%"},e.createElement(G,null,e.createElement(m,{fontWeight:500,fontSize:"1.1rem"},"Data format not support!"),e.createElement(m,{className:"color-text"},"Try to change to Testdata or Loki datasource, then look into its data format in Panel Debug"))))),xe="log-toolbar-",ke="log-view-",Le=o=>{const{dashboardId:u,panel:n}=o,w=xe+u+n.id,k=ke+u+n.id,[d,h]=s.useState(D.get(w)??!1),[L,M]=s.useState(!0),[l,H]=s.useState(""),[i,E]=s.useState([]),[x,A]=s.useState("or"),[S,z]=s.useState(D.get(k)??{maxBars:20,barType:"labels"}),g=o.data.flat(),t=s.useMemo(()=>{const a=pe[n.styles.palette];return new fe(a)},[n.styles.palette]),r=s.useMemo(()=>{const a=[];for(const y of g){const p=y.labels,v=y.values.length;for(const c of Object.keys(p)){const f=a.find(C=>C.name==c&&C.value==p[c]);f?f.count+=v:a.push({id:I(c,p[c]),name:c,value:p[c],count:v})}for(const c of y.values)c[0]=Number(c[0])}return a},[g]);s.useEffect(()=>{n.plugins.log.toolbar.show||D.remove(w)},[n.plugins.log.toolbar.show]);const ee=()=>{d?D.remove(w):D.set(w,!0),h(!d)},te=s.useCallback(a=>{M(a)},[]),le=s.useCallback(a=>{H(a.toLowerCase().trim())},[]),ae=s.useCallback(a=>{i.includes(a)?T.remove(i,y=>a==y):i.push(a),E(T.cloneDeep(i))},[i]),oe=s.useCallback(()=>{A(x=="or"?"and":"or")},[]),ne=s.useCallback(a=>{z(a),D.set(k,a)},[]),se=s.useCallback(a=>{E(y=>y.includes(a)?[]:[a])},[]),V=s.useMemo(()=>{const a=[];for(const y of g){const p=y.labels;if(i.length>0){let v=!1;if(x=="or")for(const c of Object.keys(p))i.find(f=>f==I(c,p[c]))&&(v=!0);else{let c=!0;const f=[];for(const C of Object.keys(p))f.push({name:C,value:p[C]});for(const C of i)if(!f.find(N=>C==I(N.name,N.value))){c=!1;break}v=c}if(!v)continue}for(const v of y.values){const c=v[0],f=v[1],C=f.toLowerCase();if(l=="")a.push({labels:p,timestamp:c,content:f,highlight:null});else{const N=l.includes("||"),U=l.includes("&&");if(!N&&!U)C.includes(l)&&a.push({labels:p,timestamp:c,content:f,highlight:[l]});else if(N){const W=l.split("||");for(const Y of W){const j=Y.trim();if(C.includes(j)){a.push({labels:p,timestamp:c,content:f,highlight:[j]});break}}}else if(U){const W=l.split("&&");let Y=!0;for(const j of W)if(!C.includes(j.trim())){Y=!1;break}Y&&a.push({labels:p,timestamp:c,content:f,highlight:W})}}}}return a},[g,l,i]),Q=s.useMemo(()=>n.plugins.log.orderBy=="newest"?T.sortBy(V,["timestamp"]).reverse():T.sortBy(V,["timestamp"]),[V,n.plugins.log.orderBy]);return e.createElement(e.Fragment,null,e.createElement(F,{position:"relative"},n.plugins.log.toolbar.show&&e.createElement(b,{position:"absolute",right:"2",top:"2",zIndex:1,onClick:ee,fontSize:"0.7rem",opacity:"0.4",cursor:"pointer",p:"2px",className:d?"color-text":null},e.createElement(be,null)),e.createElement(b,{height:o.height,maxHeight:o.height,width:o.width-(d?n.plugins.log.toolbar.width:1),transition:"all 0.3s",py:"2",overflowY:"auto"},n.plugins.log.chart.show&&e.createElement(b,{className:"log-panel-chart",height:n.plugins.log.chart.height},e.createElement(ye,{data:Q,panel:n,width:o.width-(d?n.plugins.log.toolbar.width:1),viewOptions:S,onSelectLabel:se,activeLabels:i,colorGenerator:t})),e.createElement(G,{alignItems:"left",divider:n.plugins.log.styles.showlineBorder&&e.createElement(de,null),mt:"1"},Q.map(a=>e.createElement(we,{log:a,panel:n,collapsed:L,width:o.width,colorGenerator:t})))),e.createElement(b,{className:"bordered-left",height:o.height,maxHeight:o.height,width:d?n.plugins.log.toolbar.width:0,transition:"all 0.3s"},e.createElement(Ee,null,d&&e.createElement(ve,{active:i,labels:r,panel:n,onCollapseAll:te,onSearchChange:le,height:o.height,onActiveLabel:ae,activeOp:x,onActiveOpChange:oe,currentLogsCount:V.length,onViewLogChange:ne,viewOptions:S,colorGenerator:t})))))};export{De as default};
